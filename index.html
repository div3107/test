<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analytics Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --ink: #0b1220;
      --navy: #0f172a;
      --muted: #667085;
      --mint: #10b981;
      --sky: #38bdf8;
      --coral: #f97316;
      --rose: #e11d48;
      --violet: #6366f1;
      --card: rgba(255, 255, 255, 0.9);
      --stroke: rgba(15, 23, 42, 0.08);
      --shadow: 0 20px 60px rgba(2, 8, 23, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", system-ui, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #fff6e7, transparent),
                  radial-gradient(900px 700px at 90% 0%, #e8f7ff, transparent),
                  linear-gradient(160deg, #f8f4ed 0%, #eef2ff 40%, #f4f7f2 100%);
      color: var(--ink);
    }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 28px 60px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: conic-gradient(from 200deg, var(--violet), var(--sky), var(--mint), var(--coral), var(--violet));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.7);
    }

    .brand h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .hero {
      margin-top: 26px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 24px;
    }

    .hero-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 24px;
      padding: 26px;
      box-shadow: var(--shadow);
    }

    .hero h2 {
      margin: 0 0 10px;
      font-size: 32px;
      font-weight: 700;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.6;
    }

    .hero-actions {
      display: flex;
      gap: 12px;
      margin-top: 18px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--navy);
      color: #fff;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.06);
      color: var(--navy);
    }

    .kpi-grid {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 16px;
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .kpi h4 {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }

    .kpi p {
      margin: 8px 0 0;
      font-size: 24px;
      font-weight: 700;
    }

    .kpi small {
      display: block;
      margin-top: 6px;
      color: var(--muted);
    }

    .section-title {
      margin: 34px 0 16px;
      font-size: 18px;
      font-weight: 700;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .chart-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 20px;
      padding: 18px 18px 12px;
      box-shadow: var(--shadow);
      min-height: 320px;
      height: 360px;
      display: flex;
      flex-direction: column;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .chart-title {
      font-size: 14px;
      font-weight: 700;
    }

    .chart-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .chart-empty {
      margin: auto;
      color: var(--muted);
      font-size: 14px;
      display: none;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      flex: 1;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.06);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .error-banner {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(225, 29, 72, 0.12);
      color: #9f1239;
      border: 1px solid rgba(225, 29, 72, 0.25);
      display: none;
      font-size: 13px;
    }

    .error-banner.show { display: block; }

    @media (max-width: 980px) {
      .hero { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body data-api-base="https://test-oqnm.onrender.com">
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <h1>Analytics Command Center</h1>
      </div>
      <span class="badge">Live data</span>
    </div>
    <div id="errorBanner" class="error-banner"></div>

    <section class="hero">
      <div class="hero-card">
        <h2>Live view of users and subscriptions</h2>
        <p>
          One unified dashboard from your Google Sheets data. Spot adoption patterns,
          subscription momentum, and risk distribution at a glance.
        </p>
        <div class="hero-actions">
          <button id="reloadBtn" class="btn-primary" onclick="reload()">Refresh data</button>
          <button class="btn-ghost" onclick="window.scrollTo({top: 900, behavior: 'smooth'})">Jump to charts</button>
        </div>
      </div>
      <div class="hero-card">
        <div class="section-title" style="margin:0 0 10px;">Data sources</div>
        <p>USERS_MASTER and SUBSCRIPTIONS are loaded from the spreadsheet and merged in this dashboard.</p>
        <div class="kpi-grid" style="margin-top:16px;">
          <div class="kpi">
            <h4>Data sync</h4>
            <p id="syncStatus">Ready</p>
            <small id="syncTime">Waiting for refresh</small>
          </div>
          <div class="kpi">
            <h4>Rows loaded</h4>
            <p id="rowsTotal">--</p>
            <small id="rowsDetail">Users + subscriptions</small>
          </div>
        </div>
      </div>
    </section>

    <div class="kpi-grid">
      <div class="kpi"><h4>Total users</h4><p id="kpiUsers">--</p><small>Unique users</small></div>
      <div class="kpi"><h4>Completed</h4><p id="kpiCompleted">--</p><small>Registration status</small></div>
      <div class="kpi"><h4>Verified</h4><p id="kpiVerified">--</p><small>Email verified</small></div>
      <div class="kpi"><h4>Conversion</h4><p id="kpiConversion">--</p><small>Completed / total</small></div>
      <div class="kpi"><h4>Total subscriptions</h4><p id="kpiSubs">--</p><small>All records</small></div>
      <div class="kpi"><h4>Active subs</h4><p id="kpiActive">--</p><small>Status based</small></div>
    </div>

    <div class="section-title">Users breakdown</div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Users by plan</div>
          <div class="chart-meta">Plan</div>
        </div>
        <div class="chart-empty" id="emptyPlan">No plan data found</div>
        <canvas id="chartPlan"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Users by risk</div>
          <div class="chart-meta">Risk</div>
        </div>
        <div class="chart-empty" id="emptyRisk">No risk data found</div>
        <canvas id="chartRisk"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Registration status</div>
          <div class="chart-meta">Status</div>
        </div>
        <div class="chart-empty" id="emptyReg">No status data found</div>
        <canvas id="chartReg"></canvas>
      </div>
    </div>

    <div class="section-title">Subscriptions breakdown</div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Subscriptions by status</div>
          <div class="chart-meta">Status</div>
        </div>
        <div class="chart-empty" id="emptySubStatus">No status data found</div>
        <canvas id="chartSubStatus"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Subscriptions by plan</div>
          <div class="chart-meta">Plan</div>
        </div>
        <div class="chart-empty" id="emptySubPlan">No plan data found</div>
        <canvas id="chartSubPlan"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Billing interval</div>
          <div class="chart-meta">Interval</div>
        </div>
        <div class="chart-empty" id="emptySubInterval">No interval data found</div>
        <canvas id="chartSubInterval"></canvas>
      </div>
    </div>
  </div>

  <script>
    const palette = ["#0ea5e9", "#f97316", "#10b981", "#e11d48", "#6366f1", "#f59e0b", "#14b8a6", "#8b5cf6"];
    const API_BASE = (document.body.dataset.apiBase || "").replace(/\/$/, "");
    let charts = [];
    let isLoading = false;

    function normalizeKey(key) {
      return String(key).toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    function firstRowWithKeys(rows) {
      if (!rows || rows.length === 0) return null;
      for (const row of rows) {
        if (row && Object.keys(row).length > 0) return row;
      }
      return null;
    }

    function findColumn(rows, candidates) {
      const sample = firstRowWithKeys(rows);
      if (!sample) return null;
      const keys = Object.keys(sample);
      const map = {};
      keys.forEach(k => { map[normalizeKey(k)] = k; });
      for (const c of candidates) {
        const hit = map[normalizeKey(c)];
        if (hit) return hit;
      }
      return null;
    }

    function filterRows(rows) {
      if (!Array.isArray(rows)) return [];
      return rows.filter(row => {
        if (!row || Object.keys(row).length === 0) return false;
        return Object.values(row).some(val => {
          if (val === null || val === undefined) return false;
          if (typeof val === "string" && val.trim() === "") return false;
          return true;
        });
      });
    }

    function preferCounts(primary, fallback) {
      if (primary && Object.keys(primary).length > 0) return primary;
      if (fallback && Object.keys(fallback).length > 0) return fallback;
      return null;
    }

    function uniqueCount(rows, col) {
      if (!col) return rows.length;
      const set = new Set();
      rows.forEach(r => set.add(String(r[col] ?? "")));
      return set.size;
    }

    function countMatch(rows, col, values) {
      if (!col) return 0;
      const lookup = values.map(v => String(v).toLowerCase());
      return rows.filter(r => lookup.includes(String(r[col] ?? "").toLowerCase())).length;
    }

    function groupCounts(rows, col) {
      if (!col) return null;
      const counts = {};
      rows.forEach(r => {
        const raw = r[col];
        const key = String(raw ?? "Unknown").trim() || "Unknown";
        counts[key] = (counts[key] || 0) + 1;
      });
      return counts;
    }

    function pickColors(n) {
      return Array.from({length: n}, (_, i) => palette[i % palette.length]);
    }

    function renderChart(id, type, counts, emptyId) {
      const canvas = document.getElementById(id);
      const empty = document.getElementById(emptyId);
      if (!counts || Object.keys(counts).length === 0) {
        canvas.style.display = "none";
        empty.style.display = "block";
        return;
      }

      const labels = Object.keys(counts);
      const values = Object.values(counts);
      const colors = pickColors(labels.length);

      canvas.style.display = "block";
      empty.style.display = "none";

      const chart = new Chart(canvas, {
        type,
        data: {
          labels,
          datasets: [{
            data: values,
            label: "Count",
            backgroundColor: type === "line" ? "rgba(14, 165, 233, 0.2)" : colors,
            borderColor: type === "line" ? "#0ea5e9" : colors,
            borderWidth: type === "bar" ? 0 : 1,
            borderRadius: type === "bar" ? 8 : 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: type !== "bar" } },
          scales: type === "bar" ? {
            x: { ticks: { color: "#475569" } },
            y: { ticks: { color: "#475569", precision: 0 }, beginAtZero: true }
          } : {}
        }
      });

      charts.push(chart);
    }

    async function reload() {
      if (isLoading) return;
      isLoading = true;
      const btn = document.getElementById("reloadBtn");
      btn.disabled = true;
      document.getElementById("syncStatus").innerText = "Loading";
      document.getElementById("syncTime").innerText = new Date().toLocaleString();
      const errorBanner = document.getElementById("errorBanner");
      errorBanner.classList.remove("show");
      errorBanner.textContent = "";

      try {
        charts.forEach(c => c.destroy());
        charts = [];

        if (!API_BASE || API_BASE.includes("YOUR-RENDER-SERVICE")) {
          throw new Error("Set data-api-base to your Render URL (example: https://your-service.onrender.com).");
        }

        const resp = await fetch(`${API_BASE}/data`);
        if (!resp.ok) {
          throw new Error(`API error ${resp.status}: ${resp.statusText}`);
        }
        const payload = await resp.json();
        const users = filterRows(payload.users_master || []);
        const subs = filterRows(payload.subscriptions || []);

      const userIdCol = findColumn(users, ["telegram_user_id", "TelegramUserID", "UserID", "user_id", "userid"]);
      const regCol = findColumn(users, ["onboarding_status", "RegistrationStatus", "Status", "registration_status"]);
      const verifiedCol = findColumn(users, ["email_verified", "EmailVerified", "Verified", "email_verified"]);
        const planCol = findColumn(users, ["investment_plan", "plan_name", "plan_code", "InvestmentPlanSelected", "Plan", "plan"]);
        const riskCol = findColumn(users, ["risk_level", "risk", "RiskOptionSelected", "Risk"]);

        const subStatusCol = findColumn(subs, ["status", "Status", "SubscriptionStatus", "subscription_status"]);
        const subPlanCol = findColumn(subs, ["plan_name", "plan_code", "Plan", "PlanName", "plan"]);
        const subIntervalCol = findColumn(subs, ["interval", "billing_interval", "period", "Interval", "BillingInterval", "Period", "robot_duration"]);
        const subRiskCol = findColumn(subs, ["robot_risk_level", "risk_level", "risk"]);

        const totalUsers = uniqueCount(users, userIdCol);
      const completed = countMatch(users, regCol, ["completed", "complete"]);
      const verified = countMatch(users, verifiedCol, ["yes", "true", "verified"]);
        const conversion = totalUsers ? ((completed / totalUsers) * 100).toFixed(1) + "%" : "--";

        document.getElementById("kpiUsers").innerText = totalUsers || "--";
        document.getElementById("kpiCompleted").innerText = regCol ? completed : "--";
        document.getElementById("kpiVerified").innerText = verifiedCol ? verified : "--";
        document.getElementById("kpiConversion").innerText = regCol ? conversion : "--";
        document.getElementById("kpiSubs").innerText = subs.length || "--";
        document.getElementById("kpiActive").innerText = subStatusCol ? countMatch(subs, subStatusCol, ["active"]) : "--";

        document.getElementById("rowsTotal").innerText = users.length + subs.length;
        document.getElementById("rowsDetail").innerText = users.length + " users + " + subs.length + " subs";
        document.getElementById("syncStatus").innerText = "Fresh";

        const userPlanCounts = groupCounts(users, planCol);
        const subPlanCounts = groupCounts(subs, subPlanCol);
        const planCounts = preferCounts(userPlanCounts, subPlanCounts);

        const userRiskCounts = groupCounts(users, riskCol);
        const subRiskCounts = groupCounts(subs, subRiskCol);
        const riskCounts = preferCounts(userRiskCounts, subRiskCounts);

        const planLabel = (userPlanCounts && Object.keys(userPlanCounts).length > 0)
          ? "Users by plan"
          : "Subscriptions by plan";
        const riskLabel = (userRiskCounts && Object.keys(userRiskCounts).length > 0)
          ? "Users by risk"
          : "Subscriptions by risk";

        document.querySelector("#chartPlan").closest(".chart-card").querySelector(".chart-title").innerText = planLabel;
        document.querySelector("#chartRisk").closest(".chart-card").querySelector(".chart-title").innerText = riskLabel;

        renderChart("chartPlan", "bar", planCounts, "emptyPlan");
        renderChart("chartRisk", "pie", riskCounts, "emptyRisk");
        renderChart("chartReg", "bar", groupCounts(users, regCol), "emptyReg");

        renderChart("chartSubStatus", "doughnut", groupCounts(subs, subStatusCol), "emptySubStatus");
        renderChart("chartSubPlan", "bar", groupCounts(subs, subPlanCol), "emptySubPlan");
        renderChart("chartSubInterval", "pie", groupCounts(subs, subIntervalCol), "emptySubInterval");
      } catch (err) {
        errorBanner.textContent = `Data load failed: ${err.message}`;
        errorBanner.classList.add("show");
        document.getElementById("syncStatus").innerText = "Error";
      } finally {
        btn.disabled = false;
        isLoading = false;
      }
    }

    reload();
  </script>
</body>
</html>
